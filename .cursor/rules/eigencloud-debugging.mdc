---
description: EigenCloud debugging workflow - read project docs and Context7 before fixing errors
alwaysApply: true
---

# EigenCloud Debugging Protocol

When debugging errors related to EigenCloud, EigenCompute, or EigenAI (e.g., `ecloud` CLI errors, deployment failures, API errors), follow this protocol before attempting fixes.

## Trigger Keywords

Apply this protocol when the user reports errors containing:
- `ecloud` CLI errors
- EigenCompute deployment issues
- EigenAI API failures
- TEE/wallet/MNEMONIC issues
- Grant authentication errors

## Required Steps

### 1. Read Project Documentation

Read these files to understand the project architecture and implementation:

- `docs/eigenskills-build-plan.md` — Full architecture, component design, env vars, API routes
- `docs/README.md` — Project structure, setup instructions, chains reference
- `docs/eigenai-reference.md` — EigenAI API, grant auth flow, signature verification
- `docs/eigencompute-reference.md` — CLI commands, Dockerfile requirements, TEE wallet

### 2. Query Context7

Query the official EigenCloud documentation for current CLI syntax and API details:

```
Library ID: /layr-labs/eigencloud-docs

Example queries:
- "ecloud compute app deploy command syntax and flags"
- "EigenAI grant authentication flow"
- "EigenCompute environment variables and configuration"
```

### 3. Cross-Reference and Fix

Compare project docs with official docs, then implement fixes with citations.

## Context7 Queries by Error Type

| Error Pattern | Context7 Query |
|---------------|----------------|
| `ecloud compute app deploy` failures | "ecloud compute app deploy command syntax image-ref flags" |
| `command not found` in CLI | "ecloud CLI installation and command structure" |
| EigenAI 401/403 errors | "EigenAI authentication grant-based wallet signature" |
| Environment variable issues | "EigenCompute environment variables MNEMONIC encryption" |
| Docker/TEE deployment | "EigenCompute Dockerfile requirements linux/amd64 root" |

## Deploy Strategy

The backend uses CLI as the primary deployment path with SDK as fallback:

| Strategy | When Used | Docker? | File |
|----------|-----------|---------|------|
| **CLI** (primary) | Always tried first | No | `backend/src/eigencompute.ts` — `deployViaCli()` with tested flags |
| SDK (fallback) | When CLI fails + non-verifiable | No | `backend/src/eigencompute-sdk.ts` — uses `@layr-labs/ecloud-sdk` |
| GitHub Actions | When `USE_GITHUB_ACTIONS=true` | No (on host) | `backend/src/eigencompute.ts` — triggers workflow |

**CLI is preferred** because it auto-layers TEE tools (KMS client, env script, labels, ENTRYPOINT) at deploy time. This allows a simple Dockerfile without manual TEE setup. The SDK path skips auto-layering and would require manual TEE toolchain in the Dockerfile.

**Verifiable Build:** The CLI prompts "Build from verifiable source?" — the frontend exposes this as a toggle (default: true). Answer is piped via `echo "y"` or `echo "n"`.

## Known Issues and Solutions

| Error | Root Cause | Solution |
|-------|------------|----------|
| `Error: Docker is not running` | CLI requires Docker daemon even for pre-built images | Use `DEPLOY_STRATEGY=sdk` (default) — no Docker needed |
| `ExitPromptError: User force closed the prompt` | CLI prompts in non-interactive mode | Pipe `echo N \|` before command (CLI strategy only) |
| `command compute:app:deploy:image:tag not found` | Colon parsed as oclif subcommand separator | Use `--image-ref` flag instead of positional arg |
| `spawnSync /bin/sh ENOBUFS` | `yes N \|` infinite output overflows buffer | Use `echo N \|` instead |
| `Failed to pull image ... 404` | Image not pushed to Docker Hub | Build with `--platform linux/amd64` and push |
| Private key in error logs | `execSync` includes command in error message | Wrap in try/catch, sanitize with regex |
| `EIGENCOMPUTE_PRIVATE_KEY not set` | Missing env var | Set in `.env` or Fly.io secrets |
| `ECONNREFUSED` on agent instance IP | Server bound to `localhost` instead of `0.0.0.0` | Use `app.listen(PORT, "0.0.0.0", cb)` — TEE containers must bind all interfaces |
| `Workload completed` + immediate shutdown in TEE logs | Container exited or server unreachable (log redirection blocked in hardened mode) | Check `0.0.0.0` binding first; add `process.on("uncaughtException")` handler to prevent silent crashes |
| `logging redirection only allowed on debug environment by image` | TEE hardened mode blocks stdout capture | Informational only — use `logVisibility: "private"` and add external logging (startup beacon, backend heartbeat) |

## Context7 Queries by Error Type (Extended)

| Error Pattern | Context7 Query |
|---------------|----------------|
| Container deployed but unreachable | "EigenCompute port exposure network binding 0.0.0.0" |
| TEE logs show `Workload completed` | "Confidential Space return codes workload completed debug" |

## Do Not

- Guess CLI syntax without checking both project docs AND Context7
- Assume flag names (they may differ between CLI versions)
- Skip the documentation lookup even if you think you know the answer
- Use `yes N |` for piping (causes buffer overflow) — use `echo "y"` or `echo "n"` instead
- Pass image reference as positional argument (use `--image-ref` flag)
- Log raw `execSync` errors without sanitizing private keys
- Add TEE tools to Dockerfile manually — CLI auto-layers them at deploy time
- Bind Express/HTTP servers to `localhost` — always use `0.0.0.0` in containers deployed to EigenCompute
- Use `logVisibility: "public"` — hardened TEE mode blocks it; use `"private"` instead
